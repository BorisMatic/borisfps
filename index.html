<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Boris shooter</title>
        <link rel="stylesheet" type="text/css" href="css/style.css"/>
    </head>
    <body>
        <script src="/socket.io/socket.io.js"></script>
        <script src="js/three.min.js"></script>
        <script src="js/cannon.js"></script>
        <script src="js/PointerLockControls.js"></script>
        <script src="js/Players.js"></script>
        <script src="js/Chest.js"></script>
        <script src="js/jquery.js"></script>
        <script src="js/Propper.js"></script>
        <script src="js/terrain_objects/Floor.js"></script>
        <script src="js/initFunctions.js"></script>
        <script src="js/terrain_objects/SkyBox.js"></script>
        <script src="js/terrain_objects/Walls.js"></script>
        <script src="js/terrain_objects/Light.js"></script>
        <script src="js/terrain_objects/Terrain.js"></script>
        <script src="js/JsonObjects.js"></script>
        <script src="js/Animate.js"></script>
        <script src="js/Listeners.js"></script>
        <script src="js/ServerFunctions.js"></script>
        <script src="js/Weapon.js"></script>

 
        <div id="blocker">

            <div id="instructions">
                <span style="font-size:40px">Click to play</span>
                <br />
                (W,A,S,D = Move, SPACE = Jump, MOUSE = Look, CLICK = Shoot)
            </div>

        </div>

        <div id="health">
            <h2>health:100%</h2>      
        </div>

        <div id="weapons">
            <div id="first" class="small">
                
            </div>
            <div id="second" class="small">
                
            </div> 
            <div id="third" class="small">
                
            </div> 
            <div id="fourth" class="small">
                
            </div>    
        </div>
        

        <script>
            var sphereShape, sphereBody, world, physicsMaterial, balls=[], ballMeshes=[], boxes=[];
            var dt = 1/60;
            var camera, scene, renderer;
            var geometry, material, mesh;
            var controls,time = Date.now();
            var rotWorldMatrix;
            var players = new Players();
            var ett ;
            var ett2 ;
            var animation;
            var myName;
            var clock = new THREE.Clock();
            INV_MAX_FPS = 1 / 60;
            frameDelta = 0;
            var socket = io();
            var rememberedTime =0;
            var jsonObjectLoader = new JsonObjects();

            raycaster = new THREE.Raycaster( new THREE.Vector3(), new THREE.Vector3(0,0,1), 0, 100 );

            
            var listeners = new Listeners(document);

            initCannon();
            init();
            animate();


            var ballShape = new CANNON.Sphere(0.2);
            var ballGeometry = new THREE.SphereGeometry(ballShape.radius, 32, 32);
            var shootDirection = new THREE.Vector3();
            var shootVelo = 60;
            var projector = new THREE.Projector();
            function getShootDir(targetVec){
                var vector = targetVec;
                targetVec.set(0,0,1);
                projector.unprojectVector(vector, camera);
                var ray = new THREE.Ray(sphereBody.position, vector.sub(sphereBody.position).normalize() );
                targetVec.x = ray.direction.x;
                targetVec.y = ray.direction.y;
                targetVec.z = ray.direction.z;
            }

            window.addEventListener("click",function(e){
                if(controls.enabled==true){
                    var x = sphereBody.position.x;
                    var y = 3;
                    var z = sphereBody.position.z;
                    var ballBody = new CANNON.Body({ mass: 1 });
                    ballBody.addShape(ballShape);
                    var ballMesh = new THREE.Mesh( ballGeometry, material );
                    world.add(ballBody);
                    scene.add(ballMesh);
                    ballMesh.castShadow = true;
                    ballMesh.receiveShadow = true;
                    balls.push(ballBody);
                    ballMeshes.push(ballMesh);
                    getShootDir(shootDirection);
                    ballBody.velocity.set(  shootDirection.x * shootVelo,
                                            shootDirection.y * shootVelo,
                                            shootDirection.z * shootVelo);

                    // Move the ball outside the player sphere
                    x += shootDirection.x * (sphereShape.radius*1.02 + ballShape.radius);
                    y += shootDirection.y * (sphereShape.radius*1.02 + ballShape.radius);
                    z += shootDirection.z * (sphereShape.radius*1.02 + ballShape.radius);
                    ballBody.position.set(x,y,z);
                    ballMesh.position.set(x,y,z);
                }
            });

            socket.emit('give', "a");
            
        </script>
    </body>
</html>
